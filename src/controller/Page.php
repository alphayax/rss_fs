<?php

namespace alphayax\rssfs\controller;

use alphayax\rssfs\model\Directory;

/**
 * Class Page
 * @package alphayax\rssfs
 */
class Page
{
    /** @var \alphayax\rssfs\model\Directory */
    protected $directory;

    /** @var bool */
    protected $includeSubFolders;

    /** @var \SimpleXMLElement */
    protected $rss;

    /**
     * Page constructor.
     * @param \alphayax\rssfs\model\Directory $directory
     * @param bool                            $includeSubFolder
     */
    public function __construct(Directory $directory, bool $includeSubFolder = false)
    {
        $this->directory = $directory;
        $this->includeSubFolders = $includeSubFolder;
    }

    /**
     *
     */
    protected function initRssHead()
    {
        $this->rss->addChild('channel'); //add channel node
        $this->rss->addChild('title', $this->directory->getTitle());
        $this->rss->addChild('description', $this->directory->getDescription());
        $this->rss->addChild('link', $this->directory->getAccessUrl());
        $this->rss->addChild('language', $this->directory->getLanguage());

        //Create RFC822 Date format to comply with RFC822
        $date_f = date(DATE_RFC2822, time());
        $this->rss->addChild('lastBuildDate', $date_f); //feed last build date

        $this->rss->addChild('generator', 'RssFs');
    }

    /**
     * Add the files in the directory
     * @param string $directory
     */
    protected function addFilesFromDirectory(string $directory)
    {
        $dir = new \DirectoryIterator($directory);
        foreach ($dir as $fileinfo) {
            $this->addFile($fileinfo);
        }
    }

    /**
     * @param \DirectoryIterator $fileInfo
     */
    protected function addFile(\DirectoryIterator $fileInfo)
    {
        if ($fileInfo->isDot()) {
            return;
        }

        if ($fileInfo->isDir()) {
            if ($this->includeSubFolders) {
                $this->addFilesFromDirectory($fileInfo->getRealPath());
            }
            return;
        }

        $file_rdi = str_replace($this->directory->getDirectoryAd(), '', $fileInfo->getRealPath());


        $item = $this->rss->addChild('item');

        $item->addChild('title', $fileInfo->getBasename());
        $item->addChild('link', $this->directory->getAccessUrl() . $file_rdi);
        $guid = $item->addChild('guid', md5($fileInfo->getRealPath()));
        $guid->addAttribute('isPermaLink', 'false');

        $item->addChild('description', '<![CDATA[' . htmlentities($fileInfo->getBasename()) . ']]>');

        $date_rfc = gmdate(DATE_RFC2822, $fileInfo->getCTime());
        $item->addChild('pubDate', $date_rfc);
    }

    /**
     * Explore directory and generate RSS
     */
    protected function explore()
    {
        $this->rss = new \SimpleXMLElement('<rss></rss>');
        $this->rss->addAttribute('version', '2.0');
        $this->initRssHead();
        $this->addFilesFromDirectory($this->directory->getDirectoryAd());
    }

    /**
     * @return \SimpleXMLElement
     */
    public function getXML()
    {
        if (empty($this->rss)) {
            $this->explore();
        }
        return $this->rss->asXML();
    }

    public function display()
    {
        header('Content-Type: text/xml; charset=utf-8', true);
        echo $this->getXML();
    }

}
